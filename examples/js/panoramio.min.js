$(document).ready(function () {
    var a;
    var c = function () {
        var l = $("#map");
        l.height($(window).height() - $("div.navbar").outerHeight() - 258);
        if (a) {
            a.invalidateSize()
        }
    };
    $(window).on("resize", function () {
        c()
    });
    c();
    a = L.map("map").setView([0, 0], 2);
    var i = L.tileLayer("http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png", {
        attribution: 'Tiles Courtesy of MapQuest <img width="10" height="10" alt="" style="margin-top: -6px;" src="http://developer.mapquest.com/content/osm/mq_logo.png">',
        detectRetina: true
    });
    i.addTo(a);
    var b = new L.Control.Layers({"Map Quest": i});
    var j = new links.Timeline($("#timeline").get(0));
    var k = {width: "99.99%", height: "240px", editable: false, style: "box"};
    j.draw([], k);
    var d = [];
    var e = null;
    var h = function () {
        var m = j.getSelection();
        if (m.length > 0) {
            var o = m[0].row;
            var n = j.getItem(o);
            var p = $(n.content).attr("data-id");
            var l = d[p];
            if (e && e.viewedImage) {
                e.viewedImage.fire("click")
            }
            l._map.panTo(l.getLatLng());
            l.fire("click");
            e = l
        }
    };
    links.events.addListener(j, "select", h);
    var f = 0;
    var g = new L.PanoramioLayer({
        photoSet: "full", onEachPhoto: function (o, n) {
            var l = n.upload_date;
            var m = n.photo_file_url;
            var s = moment(l, "DD MMM YYYY");
            var r = s.toDate();
            var p = {
                start: r,
                content: '<img class="photo" title="' + n.photo_title + '" onload="this.style.opacity=1" src="' + m + '" height="64" data-id="' + f + '"/>',
                className: "photo-item"
            };
            d.push(o);
            var q = function (u, t, v) {
                return function (y) {
                    var w = moment(v).subtract("days", 90).toDate();
                    var x = moment(v).add("days", 90).toDate();
                    u.setVisibleChartRange(w, x);
                    u.setSelection([{row: t}])
                }
            };
            o.on("click", q(j, f, r));
            f++;
            j.addItem(p, true);
            j.redraw();
            j.setVisibleChartRangeAuto()
        }, refreshEvents: "viewreset"
    });
    g.on("photosAvailable", function (l) {
        j.deleteAllItems();
        layoutPhotos("#gallery", JSON.parse(JSON.stringify(l.photos)), function (m) {
            return m.width / m.height
        }, function (n, o, m) {
            n.width = o;
            n.height = m;
            return n
        })
    });
    a.addLayer(g);
    $(".navbar-search").on("submit", function (l) {
        l.preventDefault();
        $.ajax({
            url: "http://nominatim.openstreetmap.org/search",
            dataType: "jsonp",
            jsonp: "json_callback",
            data: {q: $(".search-query").val(), format: "json"},
            success: function (n) {
                if (n && n.length > 0) {
                    var m = n[0];
                    a.setView(new L.LatLng(m.lat, m.lon), 10)
                }
            }
        })
    })
});