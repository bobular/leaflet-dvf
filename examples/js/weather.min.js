map = null;
var lastWeatherLayer;
var weatherfeed_callback = function (f) {
    var e = new L.PiecewiseFunction([new L.HSLHueFunction(new L.Point(100, 270), new L.Point(210, 270), {outputLuminosity: "25%"}), new L.HSLHueFunction(new L.Point(210, 270), new L.Point(320, 0), {outputLuminosity: "25%"})]);
    var c = new L.PiecewiseFunction([new L.HSLHueFunction(new L.Point(100, 270), new L.Point(210, 270), {outputLuminosity: "50%"}), new L.HSLHueFunction(new L.Point(210, 270), new L.Point(320, 0), {outputLuminosity: "50%"})]);
    var d = new L.LinearFunction(new L.Point(272, 5), new L.Point(320, 15));
    var a = 273.15;
    var g = function (l) {
        var k = l - a;
        var j = (9 / 5) * k + 32;
        return {c: k, f: j}
    };
    var i = {
        recordsField: "list",
        latitudeField: "coord.lat",
        longitudeField: "coord.lon",
        displayOptions: {
            "main.temp": {
                displayName: "Temperature",
                color: e,
                fillColor: c,
                radius: d,
                displayText: function (k) {
                    var j = g(k);
                    return j.f.toFixed(0) + "&deg;F / " + j.c.toFixed(0) + "&deg;C"
                }
            }
        },
        layerOptions: {width: 5, weight: 1, iconSize: new L.Point(60, 40), fillOpacity: 0.8, opacity: 1, radius: 6},
        tooltipOptions: {iconSize: new L.Point(100, 55), iconAnchor: new L.Point(-5, 55)},
        onEachRecord: function (n, l) {
            var m = '<table class="table table-condensed table-striped table-bordered"><thead><tr><th>Name</th><th>Value</th></tr></thead><tbody></tbody></table>';
            var k = $(m);
            var j = k.find("tbody");
            for (var o in l.main) {
                j.append("<tr><td>" + o + "</td><td>" + l.main[o] + "</td></tr>")
            }
            n.bindPopup(k.wrap("<div/>").parent().html(), {minWidth: 400, maxWidth: 400})
        }
    };
    var b = new L.MapMarkerDataLayer(f, i);
    map.addLayer(b);
    if (!lastWeatherLayer) {
        var h = b.getLegend({numSegments: 20, width: 80, className: "well"});
        $("#legend").append(h)
    }
    lastWeatherLayer = b
};
$(document).ready(function () {
    map = L.map("map").setView([0, 0], 2);
    var b = new L.StamenTileLayer("toner", {detectRetina: true});
    b.addTo(map);
    var c = function (f, d, g) {
        var e = {bbox: f, cluster: d ? "yes" : "no", callback: g || "weatherfeed_callback"};
        if (lastWeatherLayer) {
            map.removeLayer(lastWeatherLayer)
        }
        $.ajax({url: "http://api.openweathermap.org/data/2.5/box/city", data: e, type: "GET", dataType: "jsonp"})
    };
    var a = $("#get-weather");
    a.on("click", function (d) {
        d.preventDefault();
        c(map.getBounds().toBBoxString(), true)
    })
});